# Адаптация драйвера TimeStick для ядра Linux 6.11+

## Описание

Этот патч адаптирует драйвер TimeStick (USB-Ethernet адаптер с поддержкой PTP и 1PPS) для работы с ядром Linux версии 6.11 и выше, включая Ubuntu 24.04+.

## Что изменилось в ядре 6.11

1. **API работы с MAC-адресами**: Прямой доступ к `netdev->dev_addr` больше не разрешен. Необходимо использовать функции `eth_hw_addr_set()` и `eth_hw_addr_random()`.

2. **Структура net_device**: Поле `perm_addr` было удалено из структуры `net_device`.

3. **Ethtool API**: Некоторые функции были обновлены для улучшения безопасности и производительности.

## Файлы в репозитории

- `timestick_driver_kernel_6.11_patch.md` - Подробное описание всех изменений
- `timestick_kernel_6.11.patch` - Файл патча в формате unified diff
- `apply_kernel_6.11_patch.sh` - Автоматический скрипт для применения патча
- `driver_analysis_ru.md` - Анализ драйвера на русском языке
- `code_comments_translation_ru.md` - Перевод комментариев кода

## Быстрый старт

### Автоматическая установка

1. Клонируйте репозиторий и перейдите в его корень:
   ```bash
   git clone <repository_url>
   cd <repository_name>
   ```

2. Запустите скрипт автоматического патча:
   ```bash
   ./apply_kernel_6.11_patch.sh
   ```

3. Следуйте инструкциям на экране для установки драйвера.

### Ручная установка

1. Примените патч вручную:
   ```bash
   cd TimeStick/DRV
   patch -p2 < ../../timestick_kernel_6.11.patch
   ```

2. Скомпилируйте драйвер:
   ```bash
   make clean
   make
   ```

3. Установите драйвер:
   ```bash
   sudo make install
   sudo modprobe ax_usb_nic
   ```

## Проверка работоспособности

### 1. Проверка загрузки модуля
```bash
lsmod | grep ax_usb_nic
dmesg | grep ax_usb_nic
```

### 2. Проверка сетевого интерфейса
```bash
ip link show
# Найдите интерфейс, начинающийся с enx или eth
ethtool -i <interface_name>
```

### 3. Проверка PTP функциональности
```bash
# Установите linuxptp если еще не установлен
sudo apt install linuxptp

# Запустите PTP синхронизацию
sudo ptp4l -i <interface_name> -m
```

### 4. Проверка сигнала 1PPS
- Подключите осциллограф к SMA разъему на устройстве
- После успешной PTP синхронизации должны появиться импульсы 1 Гц

## Поддерживаемые версии

- **Ядро Linux**: 6.11 и выше
- **Ubuntu**: 24.04 и выше
- **Другие дистрибутивы**: Любые с ядром 6.11+

## Обратная совместимость

Патч сохраняет обратную совместимость с более старыми версиями ядра благодаря условной компиляции.

## Решение проблем

### Ошибка компиляции
```bash
# Установите заголовки ядра
sudo apt install linux-headers-$(uname -r)

# Установите инструменты сборки
sudo apt install build-essential
```

### Модуль не загружается
```bash
# Проверьте лог ядра
dmesg | tail -50

# Проверьте подпись модуля (для Secure Boot)
sudo mokutil --sb-state
```

### Нет сигнала 1PPS
1. Убедитесь, что PTP синхронизация установлена
2. Проверьте, что в Makefile включена поддержка PTP:
   ```
   ENABLE_PTP_FUNC = y
   ```

## Дополнительные настройки

### Параметры модуля
```bash
# Загрузка с параметрами
sudo modprobe ax_usb_nic bsize=16 blwt=0x10

# Постоянные параметры
echo "options ax_usb_nic bsize=16" | sudo tee /etc/modprobe.d/ax_usb_nic.conf
```

### Отладка
```bash
# Включить отладочные сообщения
echo 'module ax_usb_nic +p' | sudo tee /sys/kernel/debug/dynamic_debug/control

# Просмотр отладочных сообщений
dmesg -w | grep ax_usb_nic
```

## Контакты и поддержка

При возникновении проблем:
1. Проверьте раздел "Решение проблем"
2. Создайте issue в репозитории с описанием проблемы
3. Приложите вывод команд:
   - `uname -a`
   - `dmesg | grep ax_usb_nic`
   - `lsusb -v` (для вашего устройства)

## Лицензия

Драйвер распространяется под лицензией GPL-2.0, как указано в исходных файлах.

## Благодарности

- ASIX Electronic Corporation за исходный драйвер
- Сообществу Linux kernel за документацию по изменениям API