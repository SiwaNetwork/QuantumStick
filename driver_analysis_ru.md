# Анализ драйвера TimeStick

## Обзор проекта

TimeStick - это USB-ключ 3.2 Gen1 для гигабитного Ethernet, основанный на чипе AX88179B от компании ASIX. Главной особенностью устройства является поддержка протокола точного времени (PTP) IEEE 1588v2 и возможность вывода сигнала 1PPS (один импульс в секунду) через разъем SMA.

## Структура драйвера

Драйвер расположен в директории `TimeStick/DRV/` и состоит из следующих основных компонентов:

### Основные файлы драйвера:

1. **ax_main.c / ax_main.h** - главный модуль драйвера
   - Реализует основную логику USB сетевого адаптера
   - Управляет инициализацией и деинициализацией устройства
   - Обрабатывает передачу и прием данных
   - Поддерживает различные чипы: AX88179, AX88179A, AX88772D, AX88279

2. **ax_ptp.c / ax_ptp.h** - модуль протокола точного времени (PTP)
   - Реализует IEEE 1588v2 PTP функциональность
   - Управляет генерацией сигнала 1PPS
   - Обеспечивает синхронизацию времени с точностью до наносекунд

3. **ax88179_178a.c / ax88179_178a.h** - поддержка чипов AX88179/178A
4. **ax88179a_772d.c / ax88179a_772d.h** - поддержка чипов AX88179A/772D
5. **ax88279_programmer.c** - утилита программирования для AX88279

### Вспомогательные файлы:

- **ax_ioctl.h** - определения IOCTL команд для управления устройством
- **axcmd.c** - утилита командной строки для настройки драйвера
- **Makefile** - файл сборки драйвера

## Ключевые функции драйвера

### 1. Поддержка PTP (Precision Time Protocol)

Драйвер реализует полную поддержку протокола точного времени IEEE 1588v2:

```c
// Структура конфигурации PTP часов
static struct ptp_clock_info ax88179a_772d_ptp_clock = {
    .owner      = THIS_MODULE,
    .name       = "asix ptp",
    .max_adj    = 100000000,
    .adjfine    = ax88179a_ptp_adjfine,    // Точная подстройка частоты
    .adjtime    = ax88179a_ptp_adjtime,    // Коррекция времени
    .gettime64  = ax88179a_ptp_gettime64,  // Получение времени
    .settime64  = ax88179a_ptp_settime64,  // Установка времени
};
```

### 2. Управление сигналом 1PPS

Драйвер поддерживает генерацию сигнала 1PPS (один импульс в секунду):

```c
// Функция управления 1PPS для AX88179A
int ax88179a_ptp_pps_ctrl(struct ax_device *axdev, u8 enable)
{
    // Включение/выключение генерации 1PPS сигнала
    // через регистр 0x1894
}

// Функция управления 1PPS для AX88279
int ax88279_ptp_pps_ctrl(struct ax_device *axdev, u8 enable)
{
    // Включение/выключение генерации 1PPS сигнала
    // через регистр 0xF8C8
}
```

### 3. Высокоскоростная передача данных

Драйвер оптимизирован для USB 3.2 Gen1 (5 Гбит/с):

- Поддержка Jumbo-фреймов
- Аппаратные контрольные суммы
- Сегментация TCP (TSO)
- Поддержка VLAN

## Параметры модуля

Драйвер поддерживает следующие параметры при загрузке:

- **autodetach** - конфигурация автоотключения
- **bctrl** - управление массовым приемом (RX Bulk Control)
- **blwt** - нижний таймер массового приема
- **bhit** - верхний таймер массового приема
- **bsize** - размер очереди массового приема
- **bifg** - межкадровый интервал массового приема

## Поддерживаемые устройства

Драйвер поддерживает следующие USB ID производителей:
- ASIX (0x0B95)
- Sitecom (0x0DF6)
- Lenovo (0x17EF)
- Toshiba (0x0930)
- Samsung (0x04E8)
- D-Link (0x2001)

## Установка и использование

1. **Компиляция драйвера:**
   ```bash
   make
   ```

2. **Установка в систему:**
   ```bash
   sudo make install
   ```

3. **Загрузка драйвера:**
   ```bash
   sudo modprobe ax_usb_nic
   ```

4. **Выгрузка драйвера:**
   ```bash
   sudo modprobe -r ax_usb_nic
   ```

## Особенности реализации

1. **Точная синхронизация времени**: Драйвер обеспечивает наносекундную точность синхронизации времени через PTP протокол.

2. **Аппаратная генерация 1PPS**: Сигнал 1PPS генерируется аппаратно, что обеспечивает высокую стабильность и точность.

3. **Поддержка различных версий ядра Linux**: Драйвер содержит условную компиляцию для поддержки различных версий ядра Linux.

4. **Оптимизация производительности**: Использование NAPI (New API) для эффективной обработки сетевых пакетов.

## Применение

TimeStick с поддержкой 1PPS идеально подходит для:
- Систем точного времени
- Синхронизации научного оборудования
- Сетевого мониторинга с точными временными метками
- Систем автоматизации, требующих точной синхронизации
- GPS/GNSS приложений

## Техническая документация

В репозитории также присутствуют PDF документы с технической информацией:
- Datasheet чипа AX88279
- Схема демонстрационной платы
- Руководство по применению